<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
  <title>QR Password Vault</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --acc:#6366f1; --ok:#10b981; --err:#ef4444; --txt:#e5e7eb; }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:rgba(17,24,39,.7);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:clamp(22px,3vw,30px);margin:0 0 8px}
    .muted{opacity:.85}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 300px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;background:var(--acc);color:white}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#334155}
    .btn.danger{background:var(--err)}
    input,textarea,select{width:100%;background:#0b1220;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;color:var(--txt)}
    label{font-size:12px;opacity:.9}
    .tabs{display:flex;gap:8px;margin:10px 0 14px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;background:#1f2937;cursor:pointer;user-select:none}
    .tab.active{background:#374151}
    .videoWrap{position:relative;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
    video,canvas{width:100%;height:auto;display:block;background:#000}
    .frame{position:absolute;inset:auto 50% 10% 50%;transform:translateX(-50%);background:rgba(0,0,0,.5);padding:6px 10px;border-radius:999px;font-size:12px}
    .hint{font-size:12px;opacity:.85}
    .secret{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0b1220;border:1px dashed rgba(255,255,255,.15);padding:12px;border-radius:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:840px){.grid{grid-template-columns:1fr 1fr}}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#1f2937;font-size:12px;margin-left:6px}
    footer{opacity:.7;font-size:12px;margin-top:12px}
    .qrBox{display:inline-block;background:white;padding:8px;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>QR Password Vault <span class="badge">Web</span></h1>
      <div class="muted">
        <b>Ä°ki mod</b>: <u>OluÅŸtur</u> (ÅŸifreyi ÅŸifreleyip QR Ã¼retir) ve <u>Ã‡Ã¶z</u> (QRâ€™Ä± tarayÄ±p ÅŸifreyi gÃ¶sterir).
        Åžifreleme <b>AES-GCM</b>, anahtar tÃ¼retme Ã¶nce <b>scrypt</b> denenir; yoksa <b>PBKDF2-SHA256</b> yedeÄŸi kullanÄ±lÄ±r.
      </div>

      <div class="tabs" role="tablist">
        <div id="tab-create" class="tab" role="tab" aria-controls="panel-create">ðŸ§© QR OluÅŸtur</div>
        <div id="tab-scan" class="tab active" role="tab" aria-controls="panel-scan">ðŸ“· QR Tara (Ã‡Ã¶z)</div>
        <div id="tab-paste" class="tab" role="tab" aria-controls="panel-paste">ðŸ§¾ Metin YapÄ±ÅŸtÄ±r (Ã‡Ã¶z)</div>
      </div>

      <!-- CREATE -->
      <div id="panel-create" role="tabpanel" hidden>
        <div class="grid">
          <div>
            <label for="labelIn">Etiket (aÃ§Ä±k/metaveri)
              <span class="hint">Gizlilik iÃ§in genel bir isim Ã¶nerilir. Bu alan ÅŸifrelenmez.</span>
            </label>
            <input id="labelIn" placeholder="Ã¶rn. B1"/>

            <div style="height:10px"></div>
            <label for="categoryIn">Kategori (ÅŸifreli)</label>
            <input id="categoryIn" placeholder="Ã¶rn. e-posta, banka, vpn"/>

            <div style="height:10px"></div>
            <label for="noteIn">AÃ§Ä±klama / Not (ÅŸifreli, opsiyonel)</label>
            <input id="noteIn" placeholder="kÄ±sa aÃ§Ä±klama (yalnÄ±zca Ã§Ã¶zÃ¼nce gÃ¶rÃ¼nÃ¼r)"/>

            <div style="height:10px"></div>
            <label for="secretIn">Kaydedilecek ÅŸifre/secret</label>
            <input id="secretIn" placeholder="Ã¶rn. P@ssw0rd!"/>

            <div style="height:10px"></div>
            <label for="passCreate">Master passphrase</label>
            <input type="password" id="passCreate" autocomplete="off" placeholder="Sadece senin bildiÄŸin uzun parola" />

            <div class="row" style="margin-top:10px">
              <button class="btn secondary" id="btnDemoFill">ðŸŽ¯ Demo Doldur</button>
              <button class="btn" id="btnCreate">QR OluÅŸtur</button>
              <button class="btn secondary" id="btnCreateCopy" disabled>Decrypt Stringâ€™i Kopyala</button>
              <button class="btn secondary" id="btnDownloadQR" disabled>QRâ€™Ä± Ä°ndir (PNG)</button>
            </div>
            <div class="hint">Not: Etiket <b>aÃ§Ä±k</b>, kategori ve aÃ§Ä±klama <b>ÅŸifreli</b> saklanÄ±r.</div>
          </div>

          <div>
            <label>Ã–nizleme</label>
            <div id="qrOut" class="qrBox" style="display:none"></div>
            <div style="height:8px"></div>
            <label>Decrypt String (yedek)
              <span class="hint">Bu metni gÃ¼venli bir yerde saklayabilirsin.</span>
            </label>
            <div id="packedOut" class="secret">â€”</div>
          </div>
        </div>
      </div>

      <!-- SCAN/DECRYPT -->
      <div id="panel-scan" role="tabpanel">
        <div class="videoWrap">
          <video id="video" playsinline muted></video>
          <div class="frame" id="scanStatus">Kamera baÅŸlatÄ±lÄ±yorâ€¦</div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnStart">KamerayÄ± BaÅŸlat</button>
          <button class="btn secondary" id="btnStop" disabled>Kapat</button>
          <select id="cameraSelect" class="grow"></select>
        </div>
        <div class="hint">Ä°pucu: Kamera eriÅŸimi iÃ§in sayfayÄ± <b>https://</b> veya <b>http://localhost</b> Ã¼zerinden aÃ§.</div>
      </div>

      <!-- PASTE/DECRYPT -->
      <div id="panel-paste" role="tabpanel" hidden>
        <label for="packed">Decrypt String (QRâ€™dan Ã§Ä±kan uzun metin)</label>
        <textarea id="packed" rows="4" placeholder="base64url(JSON payload)"></textarea>
        <div style="margin-top:8px"><button class="btn" id="btnPasteDecrypt">Ã‡Ã¶z</button></div>
      </div>

      <hr style="border-color:rgba(255,255,255,.12);margin:18px 0">

      <div class="grid">
        <div>
          <label for="pass">Master passphrase (Ã‡Ã¶zme aÅŸamasÄ±nda)</label>
          <input type="password" id="pass" autocomplete="off" placeholder="Sadece bu cihazda sen biliyorsun" />
          <div class="row" style="align-items:center;margin-top:8px">
            <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="remember"/> Bu cihazda hatÄ±rla (localStorage)</label>
            <span class="hint">Sadece gÃ¼venli kiÅŸisel cihazlarda Ã¶nerilir.</span>
          </div>
        </div>
        <div>
          <label>SonuÃ§</label>
          <div id="secretBox" class="secret">â€”</div>
          <div id="resultMeta" class="hint" style="margin-top:6px"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="btnCopy" disabled>Kopyala</button>
            <button class="btn danger" id="btnHide" disabled>Gizle</button>
          </div>
          <div class="hint">Åžifre 30 sn sonra otomatik gizlenir. Sekme arka plana geÃ§ince de gizlenir.</div>
        </div>
      </div>

      <footer>
        Payload formatÄ±: base64url(JSON) â†’ { v, kdf:"scrypt"|"pbkdf2", (n,r,p | iter,hash), alg:"aes-256-gcm", salt, nonce, ct, label, ts }.
        <br>Åžifreli iÃ§eriÄŸin iÃ§inde: { secret, category, note } (geri uyumlu: eski QRâ€™larda sadece secret olabilir).
      </footer>
    </div>
  </div>

  <!-- KÃ¼tÃ¼phaneler -->
  <script src="https://cdn.jsdelivr.net/npm/scrypt-async@2.0.3/browser/scrypt-async.min.js"></script>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const b64url = {
    dec: (str) => {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      const pad = str.length % 4 === 2 ? '==' : str.length % 4 === 3 ? '=' : '';
      return Uint8Array.from(atob(str + pad), c => c.charCodeAt(0));
    },
    enc: (bytes) => {
      const bin = String.fromCharCode(...bytes);
      return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }
  };
  const txt = new TextEncoder();
  const untxt = new TextDecoder();

  // ===== KDF: scrypt (varsa) + PBKDF2 (yedek) =====
  function hasScrypt(){ return typeof window.scrypt === 'function'; }

  async function kdf_scrypt(master, salt, N, r, p){
    const pw = (master instanceof Uint8Array) ? master : txt.encode(master);
    const sl = (salt instanceof Uint8Array) ? salt : txt.encode(String(salt));
    return await new Promise((resolve, reject)=>{
      try {
        // scrypt-async: scrypt(pass, salt, N, r, p, dkLen, progressCb, resultCb, encoding)
        window.scrypt(pw, sl, N, r, p, 32, null, (key)=> resolve(new Uint8Array(key)), 'binary');
      } catch(e){ reject(e); }
    });
  }

  async function kdf_pbkdf2(master, salt, iter=210000){
    const pw  = (master instanceof Uint8Array) ? master : txt.encode(master);
    const slt = (salt   instanceof Uint8Array) ? salt   : txt.encode(String(salt));
    const key = await crypto.subtle.importKey('raw', pw, 'PBKDF2', false, ['deriveBits']);
    const bits= await crypto.subtle.deriveBits({name:'PBKDF2', hash:'SHA-256', salt:slt, iterations:iter}, key, 256);
    return { keyBytes: new Uint8Array(bits), iter };
  }

  // Ortak seÃ§imci
  async function deriveKey(master, salt, N, r, p){
    if (hasScrypt()) {
      const keyBytes = await kdf_scrypt(master, salt, N, r, p);
      return { keyBytes, kdf: 'scrypt', params: { n:N, r, p } };
    } else {
      const { keyBytes, iter } = await kdf_pbkdf2(master, salt);
      return { keyBytes, kdf: 'pbkdf2', params: { iter, hash:'SHA-256' } };
    }
  }

  function toast(msg, ok=false){
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.cssText = `position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:${ok? '#16a34a':'#334155'};color:white;padding:10px 14px;border-radius:999px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:9999;`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 2200);
  }

  // ===== Client logger -> POST /log =====
  async function logToServer(lines){
    try {
      await fetch('/log', {method:'POST', headers:{'Content-Type':'text/plain'}, body: lines});
    } catch(e) { /* file:// iken veya aÄŸ hatasÄ±nda sessiz */ }
  }
  function reportError(message, detail){
    const ts = new Date().toISOString();
    const text = `[${ts}] ${message}\n${detail || ''}`;
    console.error(text);
    logToServer(text);
    toast(message);
  }
  window.addEventListener('error', (e)=>{
    const detail = e?.error?.stack || `${e.filename}:${e.lineno}:${e.colno}`;
    reportError(`Hata: ${e.message}`, detail);
  });
  window.addEventListener('unhandledrejection', (e)=>{
    const r = e.reason;
    const msg = typeof r === 'string' ? r : (r?.message || 'Unhandled Rejection');
    const detail = r?.stack || '';
    reportError(`Hata: ${msg}`, detail);
  });

  // ===== Tabs =====
  const tabCreate = $('#tab-create');
  const tabScan   = $('#tab-scan');
  const tabPaste  = $('#tab-paste');
  const panelCreate = $('#panel-create');
  const panelScan   = $('#panel-scan');
  const panelPaste  = $('#panel-paste');
  [tabCreate, tabScan, tabPaste].forEach(t=>t.addEventListener('click', () => {
    const isCreate = t === tabCreate, isScan = t === tabScan, isPaste = t === tabPaste;
    tabCreate.classList.toggle('active', isCreate);
    tabScan.classList.toggle('active', isScan);
    tabPaste.classList.toggle('active', isPaste);
    panelCreate.hidden = !isCreate; panelScan.hidden = !isScan; panelPaste.hidden = !isPaste;
  }));

  // ===== State =====
  let hideTimer = null;
  function showSecret(text, meta){
    $('#secretBox').textContent = text;
    $('#btnCopy').disabled = false;
    $('#btnHide').disabled = false;
    const m = [];
    if (meta?.category) m.push(`Kategori: ${meta.category}`);
    if (meta?.note) m.push(`Not: ${meta.note}`);
    $('#resultMeta').textContent = m.join(' Â· ');
    if (hideTimer) clearTimeout(hideTimer);
    hideTimer = setTimeout(hideSecret, 30000);
  }
  function hideSecret(){
    $('#secretBox').textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
    $('#btnCopy').disabled = true;
    $('#btnHide').disabled = true;
    $('#resultMeta').textContent = '';
  }
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden) hideSecret(); });
  $('#btnCopy').addEventListener('click', async ()=>{
    const t = $('#secretBox').textContent;
    if (t && t !== 'â€”' && t !== 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') { await navigator.clipboard.writeText(t); toast('Panoya kopyalandÄ±', true); }
  });
  $('#btnHide').addEventListener('click', hideSecret);

  // Remember passphrase (optional)
  const pass = $('#pass');
  const remember = $('#remember');
  try { const saved = localStorage.getItem('qpv_master'); if (saved) { pass.value = saved; remember.checked = true; } } catch {}
  remember.addEventListener('change', ()=>{ try{ if (remember.checked) localStorage.setItem('qpv_master', pass.value || ''); else localStorage.removeItem('qpv_master'); }catch{} });
  pass.addEventListener('input', ()=>{ if (remember.checked){ try{localStorage.setItem('qpv_master', pass.value || '')}catch{} } });

  // ===== Decrypt (common) =====
  async function decryptPacked(packed){
    if (!packed) throw new Error('BoÅŸ iÃ§erik');
    let payload;
    try {
      const jsonStr = untxt.decode(b64url.dec(packed));
      payload = JSON.parse(jsonStr);
    } catch(e){
      throw new Error('GeÃ§ersiz Decrypt String (base64url/JSON)');
    }
    const req = ['salt','nonce','ct','alg','kdf'];
    for (const k of req){ if (!(k in payload)) throw new Error(`Eksik alan: ${k}`); }
    if (payload.alg !== 'aes-256-gcm') throw new Error('Desteklenmeyen ÅŸema');

    const salt  = b64url.dec(payload.salt);
    const nonce = b64url.dec(payload.nonce);
    const ct    = b64url.dec(payload.ct);

    const master = pass.value || '';
    if (!master) throw new Error('Passphrase girilmedi');

    // KDF'ye gÃ¶re anahtar
    let keyBytes;
    if (payload.kdf === 'scrypt') {
      if (!('n' in payload && 'r' in payload && 'p' in payload)) throw new Error('Eksik scrypt parametreleri');
      keyBytes = await kdf_scrypt(master, salt, payload.n, payload.r, payload.p);
    } else if (payload.kdf === 'pbkdf2') {
      const iter = payload.iter || 210000;
      keyBytes = (await kdf_pbkdf2(master, salt, iter)).keyBytes;
    } else {
      throw new Error('Desteklenmeyen KDF');
    }

    const cryptoKey = await crypto.subtle.importKey('raw', keyBytes, {name:'AES-GCM'}, false, ['decrypt']);
    let clear;
    try {
      clear = await crypto.subtle.decrypt({name:'AES-GCM', iv: nonce}, cryptoKey, ct);
    } catch(e){
      throw new Error('Decryption failed (passphrase yanlÄ±ÅŸ olabilir)');
    }

    // Ä°Ã§erik: eski QR'larda dÃ¼z string, yenilerde JSON
    let secret = ''; let meta = {};
    try {
      const parsed = JSON.parse(untxt.decode(new Uint8Array(clear)));
      secret = parsed.secret ?? '';
      meta = { category: parsed.category, note: parsed.note };
      if (!secret) throw new Error('no-secret');
    } catch {
      secret = untxt.decode(new Uint8Array(clear));
      meta = {};
    }

    showSecret(secret, meta);
    if (payload.label) toast(`Ã‡Ã¶zÃ¼ldÃ¼: ${payload.label}`, true);
  }

  // PASTE decrypt
  $('#btnPasteDecrypt').addEventListener('click', ()=>{
    const packed = $('#packed').value.trim();
    decryptPacked(packed).catch(e=>reportError(e.message || 'Hata (Ã§Ã¶zme)', e?.stack || ''));
  });

  // ===== Camera / QR scan =====
  const video = $('#video');
  const cameraSelect = $('#cameraSelect');
  const btnStart = $('#btnStart');
  const btnStop  = $('#btnStop');
  const scanStatus = $('#scanStatus');
  let stream = null; let scanning = false; let useBarcodeDetector = ('BarcodeDetector' in window); let detector = null;
  if (useBarcodeDetector) { try { detector = new window.BarcodeDetector({formats:['qr_code']}); } catch(e){ useBarcodeDetector = false; } }

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      cameraSelect.innerHTML = '';
      cams.forEach((c,i)=>{
        const opt = document.createElement('option');
        opt.value = c.deviceId; opt.textContent = c.label || `Kamera ${i+1}`;
        cameraSelect.appendChild(opt);
      });
    }catch{}
  }

  async function startCamera(){
    if (stream) stopCamera();
    const devId = cameraSelect.value || undefined;
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: devId ? {deviceId:{exact:devId}} : {facingMode:'environment'} });
      video.srcObject = stream; await video.play();
      btnStart.disabled = true; btnStop.disabled = false; scanning = true;
      scanLoop();
      toast('Kamera aÃ§Ä±k', true);
    } catch(e){
      reportError('Kamera aÃ§Ä±lamadÄ±', e?.message || e);
    }
  }
  function stopCamera(){
    scanning = false;
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    video.pause(); video.srcObject = null; btnStart.disabled = false; btnStop.disabled = true;
    scanStatus.textContent = 'Kamera kapalÄ±';
  }
  btnStart.addEventListener('click', startCamera);
  btnStop.addEventListener('click', stopCamera);
  cameraSelect.addEventListener('change', ()=>{ if (btnStop.disabled===false) startCamera(); });
  navigator.mediaDevices?.getUserMedia({video:true}).then(s=>{ s.getTracks().forEach(t=>t.stop()); listCameras(); }).catch(()=>{});

  async function scanLoop(){
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    while (scanning){
      if (video.readyState >= 2){
        const w = video.videoWidth, h = video.videoHeight;
        canvas.width = w; canvas.height = h; ctx.drawImage(video,0,0,w,h);
        let packed = null;
        try {
          if (useBarcodeDetector && detector){
            const bitmap = await createImageBitmap(canvas);
            const codes = await detector.detect(bitmap);
            if (codes && codes.length){ packed = codes[0].rawValue || codes[0].rawValueAsString || null; }
          } else if (window.jsQR){
            const data = ctx.getImageData(0,0,w,h);
            const code = window.jsQR(data.data, w, h, { inversionAttempts: 'dontInvert' });
            if (code) packed = code.data;
          }
        } catch{}
        if (packed){
          scanStatus.textContent = 'QR bulundu, Ã§Ã¶zÃ¼mleniyorâ€¦';
          scanning = false; stopCamera();
          decryptPacked(packed).catch(e=>reportError(e.message || 'Hata (Ã§Ã¶zme)', e?.stack || ''));
          break;
        } else {
          scanStatus.textContent = useBarcodeDetector? 'QR bekleniyorâ€¦ (native)' : 'QR bekleniyorâ€¦ (jsQR)';
        }
      }
      await new Promise(r=>setTimeout(r, 160));
    }
  }

  // ===== CREATE / ENCRYPT & QR =====
  const labelIn = $('#labelIn'); const categoryIn = $('#categoryIn'); const noteIn = $('#noteIn'); const secretIn = $('#secretIn'); const passCreate = $('#passCreate');
  const btnCreate = $('#btnCreate'); const btnCreateCopy = $('#btnCreateCopy'); const btnDownloadQR = $('#btnDownloadQR');
  const qrOut = $('#qrOut'); const packedOut = $('#packedOut');
  let lastQR = null; let lastPacked = '';

  function randomBytes(len){ const b = new Uint8Array(len); crypto.getRandomValues(b); return b; }

  async function createPacked(){
    const label = (labelIn.value || '').trim();
    const category = (categoryIn.value || '').trim();
    const note = (noteIn.value || '').trim();
    const secret = secretIn.value;
    const master = passCreate.value;
    if (!secret) throw new Error('Åžifre/secret girilmedi');
    if (!master) throw new Error('Master passphrase girilmedi');

    const inner = { secret, category, note };

    const n = 2**14, r = 8, p = 1; // gÃ¼Ã§lÃ¼ ve makul
    const salt = randomBytes(16);

    const { keyBytes, kdf, params } = await deriveKey(master, salt, n, r, p);
    const nonce = randomBytes(12);
    const cryptoKey = await crypto.subtle.importKey('raw', keyBytes, {name:'AES-GCM'}, false, ['encrypt']);
    const ctBuf = await crypto.subtle.encrypt({name:'AES-GCM', iv: nonce}, cryptoKey, txt.encode(JSON.stringify(inner)));
    const payload = {
      v: 1, kdf: kdf, alg: 'aes-256-gcm',
      ...(kdf === 'scrypt' ? { n, r, p } : {}),
      ...(kdf === 'pbkdf2' ? { iter: params.iter, hash: 'SHA-256' } : {}),
      salt: b64url.enc(salt), nonce: b64url.enc(nonce), ct: b64url.enc(new Uint8Array(ctBuf)),
      label, ts: Math.floor(Date.now()/1000)
    };
    const packed = b64url.enc(txt.encode(JSON.stringify(payload)));
    return {packed, label};
  }

  function renderQR(packed){
    qrOut.style.display = 'inline-block';
    qrOut.innerHTML = '';
    lastQR = new QRCode(qrOut, {text: packed, width: 256, height: 256, correctLevel: QRCode.CorrectLevel.M});
  }

  // Demo doldur
  function demoValues(){
    const rnd = Math.random().toString(36).slice(2,6);
    if (!labelIn.value)    labelIn.value = `demo-${rnd}`;
    if (!categoryIn.value) categoryIn.value = 'e-posta';
    if (!noteIn.value)     noteIn.value = 'deneme hesap';
    if (!secretIn.value)   secretIn.value = `P@ss-${rnd}-w0rd`;
    if (!passCreate.value) passCreate.value = 'My-Strong-Master-123!';
    toast('Demo alanlar dolduruldu', true);
  }
  document.getElementById('btnDemoFill').addEventListener('click', demoValues);
  document.addEventListener('DOMContentLoaded', ()=>{ demoValues(); });

  btnCreate.addEventListener('click', async ()=>{
    try{
      const {packed, label} = await createPacked();
      lastPacked = packed; packedOut.textContent = packed; renderQR(packed);
      btnCreateCopy.disabled = false; btnDownloadQR.disabled = false;
      toast(label ? `QR oluÅŸturuldu: ${label}` : 'QR oluÅŸturuldu', true);
    } catch(e){
      reportError(e.message || 'Hata (oluÅŸturma)', e?.stack || '');
    }
  });

  btnCreateCopy.addEventListener('click', async ()=>{
    if (!lastPacked) return;
    await navigator.clipboard.writeText(lastPacked);
    toast('Decrypt String kopyalandÄ±', true);
  });

  btnDownloadQR.addEventListener('click', ()=>{
    const img = qrOut.querySelector('img');
    if (!img) { toast('Ã–nce QR oluÅŸtur'); return; }
    const a = document.createElement('a'); a.href = img.src; a.download = 'vault_qr.png'; a.click();
  });
  </script>
</body>
</html>